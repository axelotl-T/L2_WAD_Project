<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SwiftShop</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      .hidden {
        display: none;
      }

      /* Cart Styles */
      .qty-btn {
        padding: 2px 8px;
        font-weight: bold;
        cursor: pointer;
      }
      .qty-val {
        margin: 0 10px;
        font-weight: bold;
      }

      /* Review Styles */
      .reviews-container {
        background: #f9f9f9;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        display: none;
      }
      .admin-review-item {
        border-bottom: 1px solid #ddd;
        padding: 8px 0;
        font-size: 0.9em;
      }
      .shop-review-item {
        border-bottom: 1px solid #eee;
        padding: 5px 0;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-bar">
        <h2>SwiftShop</h2>
        <div id="nav-buttons" class="hidden">
          <span style="margin-right: 15px"
            >Hi, <b id="displayUsername"></b
          ></span>
          <button class="btn btn-info" onclick="switchView('dashboard')">
            Admin Dashboard
          </button>
          <button class="btn btn-success" onclick="switchView('shop')">
            Shop
          </button>
          <button class="btn btn-warning" onclick="switchView('cart')">
            Cart (<span id="cart-count">0</span>)
          </button>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>

      <div id="view-auth">
        <div id="login-box">
          <h3>Login</h3>
          <input type="email" id="loginEmail" placeholder="Email" />
          <input type="password" id="loginPass" placeholder="Password" />
          <button class="btn btn-primary" id="btnLogin">Login</button>
          <button
            class="btn btn-secondary"
            onclick="
              $('#login-box').hide();
              $('#reg-box').show();
            "
          >
            Register
          </button>
        </div>
        <div id="reg-box" class="hidden">
          <h3>Register</h3>
          <input type="text" id="regUser" placeholder="Username" />
          <input type="email" id="regEmail" placeholder="Email" />
          <input type="password" id="regPass" placeholder="Password" />
          <input type="text" id="regPostal" placeholder="Postal Code (SG)" />
          <button class="btn btn-success" id="btnRegister">Sign Up</button>
          <button
            class="btn btn-secondary"
            onclick="
              $('#reg-box').hide();
              $('#login-box').show();
            "
          >
            Back
          </button>
        </div>
      </div>

      <div id="view-dashboard" class="hidden">
        <h3>Admin Dashboard</h3>
        <button
          class="btn btn-primary"
          onclick="$('#product-form').slideToggle()"
        >
          + Add Product
        </button>

        <div
          id="product-form"
          class="card hidden"
          style="margin-top: 10px; background: #f9f9f9"
        >
          <h4>Add/Edit Product</h4>
          <input type="hidden" id="prodId" />
          <input type="text" id="prodName" placeholder="Product Name" />
          <input type="text" id="prodDesc" placeholder="Description" />
          <input type="number" id="prodPrice" placeholder="Price" />
          <input type="number" id="prodStock" placeholder="Stock" />
          <label>Category:</label>
          <select id="prodCat"></select>
          <button class="btn btn-success" onclick="saveProduct()">Save</button>
          <button
            class="btn btn-secondary"
            onclick="$('#product-form').slideUp()"
          >
            Cancel
          </button>
        </div>

        <div id="admin-products-list" style="margin-top: 20px"></div>
      </div>

      <div id="view-shop" class="hidden">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3>Shop Products</h3>
          <div>
            <label>Filter by:</label>
            <select id="shopFilter" onchange="loadShopProducts()">
              <option value="All">All Categories</option>
            </select>
          </div>
        </div>
        <hr />
        <div class="shop-grid" id="shop-container"></div>
      </div>

      <div id="view-cart" class="hidden">
        <h3>Shopping Cart</h3>
        <div id="cart-items-container"></div>
        <hr />
        <div class="total-section">
          Total (SGD): $<span id="cart-total-sgd">0.00</span>
        </div>
        <div class="card" style="background: #f0f8ff; margin-top: 20px">
          <h4>Checkout & Currency</h4>
          <label>Select Currency:</label>
          <select id="currency-select" onchange="updateTotalCurrency()">
            <option value="SGD">SGD (Singapore Dollar)</option>
          </select>
          <h3>
            Final Total: <span id="final-total">0.00</span>
            <span id="currency-label">SGD</span>
          </h3>
          <button
            class="btn btn-success"
            onclick="alert('Checkout Successful! Thank you.')"
          >
            Checkout Now
          </button>
        </div>
      </div>
    </div>

    <script>
      let authToken = localStorage.getItem("token");
      let currentUser = localStorage.getItem("username");
      let cart = [];
      let exchangeRates = {};
      let categories = [];

      $(document).ready(function () {
        if (authToken) initApp();
        else $("#view-auth").show();
        $("#btnLogin").click(login);
        $("#btnRegister").click(register);

        fetchRates();
        fetchCategories();
      });

      function initApp() {
        $("#view-auth").hide();
        $("#nav-buttons").removeClass("hidden").show();
        $("#displayUsername").text(currentUser);
        switchView("dashboard");
      }

      function switchView(viewName) {
        $("#view-dashboard, #view-shop, #view-cart, #view-auth").hide();
        if (viewName === "dashboard") {
          $("#view-dashboard").show();
          loadAdminProducts();
        } else if (viewName === "shop") {
          $("#view-shop").show();
          loadShopProducts();
        } else if (viewName === "cart") {
          $("#view-cart").show();
          renderCart();
        }
      }

      // --- CART LOGIC ---
      function addToCart(id, name, price) {
        let existingItem = cart.find((item) => item.id === id);
        if (existingItem) {
          existingItem.qty += 1;
          alert(`Increased quantity of ${name} to ${existingItem.qty}`);
        } else {
          cart.push({ id, name, price, qty: 1 });
          alert(`${name} added to cart!`);
        }
        updateCartCount();
      }

      function updateCartCount() {
        let totalCount = cart.reduce((sum, item) => sum + item.qty, 0);
        $("#cart-count").text(totalCount);
      }

      function changeQty(index, change) {
        cart[index].qty += change;
        if (cart[index].qty <= 0) {
          cart.splice(index, 1);
        }
        updateCartCount();
        renderCart();
      }

      function renderCart() {
        let container = $("#cart-items-container");
        container.empty();
        let total = 0;

        if (cart.length === 0) {
          container.append("<p>Cart is empty.</p>");
        } else {
          cart.forEach((item, index) => {
            let itemTotal = item.price * item.qty;
            total += itemTotal;
            container.append(`
                    <div class="cart-item">
                        <div style="flex-grow:1">
                            <b>${item.name}</b><br>
                            Unit Price: $${item.price}
                        </div>
                        <div style="display:flex; align-items:center;">
                            <button class="qty-btn btn-secondary" onclick="changeQty(${index}, -1)">-</button>
                            <span class="qty-val">${item.qty}</span>
                            <button class="qty-btn btn-success" onclick="changeQty(${index}, 1)">+</button>
                        </div>
                        <div style="width:100px; text-align:right; font-weight:bold;">
                            $${itemTotal.toFixed(2)}
                        </div>
                        <button class="btn btn-danger" style="margin-left:10px" onclick="changeQty(${index}, -9999)">X</button>
                    </div>
                `);
          });
        }
        $("#cart-total-sgd").text(total.toFixed(2));
        updateTotalCurrency();
      }

      // --- ADMIN PRODUCTS & REVIEWS ---
      function loadAdminProducts() {
        $.get("/api/products", function (products) {
          let container = $("#admin-products-list");
          container.empty();
          if (!products || products.length === 0) {
            container.html("<p>No products found.</p>");
            return;
          }

          products.forEach((p) => {
            container.append(`
                <div class="card">
                    <h4>${p.name} ($${p.price})</h4>
                    <p>${p.description}</p>
                    <p>Cat: <b>${p.category}</b> | Stock: ${p.stock}</p>
                    <button class="btn btn-warning" onclick="editProduct('${p._id}')">Edit Product</button>
                    <button class="btn btn-danger" onclick="deleteProduct('${p._id}')">Delete Product</button>
                    
                    <button class="btn btn-info" onclick="$('#admin-rev-${p._id}').slideToggle()">Manage Reviews</button>
                    
                    <div id="admin-rev-${p._id}" class="reviews-container">
                        <h5>Reviews</h5>
                        <div id="admin-rev-list-${p._id}">Loading...</div>
                        <hr>
                        <small>Add Admin Comment:</small>
                        <div style="margin-top:5px;">
                            <input type="text" id="admin-rev-txt-${p._id}" placeholder="Comment" style="width:60%">
                            <input type="number" id="admin-rev-rate-${p._id}" placeholder="1-5" style="width:15%">
                            <button class="btn btn-sm btn-primary" onclick="postReview('${p._id}', false)">Post</button>
                        </div>
                    </div>
                </div>`);
            loadAdminReviews(p._id);
          });
        });
      }

      // Load reviews with EDIT/DELETE buttons for Admin
      function loadAdminReviews(pid) {
        $.get(`/api/products/${pid}/reviews`, function (reviews) {
          let div = $(`#admin-rev-list-${pid}`);
          div.empty();
          if (reviews.length === 0) {
            div.append("<small>No reviews yet.</small>");
            return;
          }

          reviews.forEach((r) => {
            let userDisplay = r.user ? r.user.username : "Unknown";
            div.append(`
                    <div id="rev-item-${r._id}" class="admin-review-item">
                        <div style="display:flex; justify-content:space-between;">
                            <span><b>${userDisplay}</b>: ${r.comment} (${r.rating}/5)</span>
                            <div>
                                <button class="btn btn-sm btn-secondary" onclick="editReviewUI('${r._id}', '${r.comment}', ${r.rating}, '${pid}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteReview('${r._id}', '${pid}')">Del</button>
                            </div>
                        </div>
                    </div>
                `);
          });
        });
      }

      // Admin Review Actions
      function deleteReview(rid, pid) {
        if (confirm("Delete this review?")) {
          $.ajax({
            url: `/api/reviews/${rid}`,
            method: "DELETE",
            headers: { Authorization: "Bearer " + authToken },
            success: () => loadAdminReviews(pid),
            error: (e) => alert("Error deleting: " + e.responseJSON.error),
          });
        }
      }

      function editReviewUI(rid, oldComment, oldRating, pid) {
        let html = `
            <input type="text" id="edit-txt-${rid}" value="${oldComment}" style="width:50%">
            <input type="number" id="edit-rate-${rid}" value="${oldRating}" style="width:15%">
            <button class="btn btn-sm btn-success" onclick="saveReview('${rid}', '${pid}')">Save</button>
            <button class="btn btn-sm btn-secondary" onclick="loadAdminReviews('${pid}')">Cancel</button>
        `;
        $(`#rev-item-${rid}`).html(html);
      }

      function saveReview(rid, pid) {
        let data = {
          comment: $(`#edit-txt-${rid}`).val(),
          rating: $(`#edit-rate-${rid}`).val(),
        };
        $.ajax({
          url: `/api/reviews/${rid}`,
          method: "PUT",
          headers: { Authorization: "Bearer " + authToken },
          data: data,
          success: () => loadAdminReviews(pid),
          error: (e) => alert("Update failed"),
        });
      }

      // --- SHOP PRODUCTS & REVIEWS ---
      function loadShopProducts() {
        let selectedCat = $("#shopFilter").val();
        let url = "/api/products";
        if (selectedCat !== "All")
          url += "?category=" + encodeURIComponent(selectedCat);

        $.get(url, function (products) {
          let container = $("#shop-container");
          container.empty();
          if (!products || products.length === 0) {
            container.html("<p>No products found.</p>");
            return;
          }

          products.forEach((p) => {
            container.append(`
                    <div class="shop-card" style="border:1px solid #eee; padding:15px; margin:5px; background:white;">
                        <h4>${p.name}</h4>
                        <p>${p.description}</p>
                        <div class="price-tag">$${p.price}</div>
                        
                        <button class="btn btn-primary" onclick="addToCart('${p._id}', '${p.name}', ${p.price})">Add to Cart</button>
                        <button class="btn btn-info" onclick="$('#shop-rev-${p._id}').slideToggle()">Show Reviews</button>
                        
                        <div id="shop-rev-${p._id}" class="reviews-container">
                            <small><b>Write a Review:</b></small><br>
                            <input type="text" id="shop-rev-txt-${p._id}" placeholder="Comment" style="width:60%">
                            <input type="number" id="shop-rev-rate-${p._id}" placeholder="1-5" style="width:20%">
                            <button class="btn btn-sm btn-success" onclick="postReview('${p._id}', true)">Post</button>
                            <hr>
                            <div id="shop-rev-list-${p._id}">Loading...</div>
                        </div>
                    </div>
                `);
            loadShopReviews(p._id);
          });
        });
      }

      function loadShopReviews(pid) {
        $.get(`/api/products/${pid}/reviews`, function (reviews) {
          let div = $(`#shop-rev-list-${pid}`);
          div.empty();
          if (reviews.length === 0) {
            div.append("<small>No reviews yet.</small>");
            return;
          }
          reviews.forEach((r) => {
            div.append(
              `<div class="shop-review-item"><b>${r.user ? r.user.username : "Unknown"}</b>: ${r.comment} (${r.rating}/5)</div>`,
            );
          });
        });
      }

      // Shared Post Function
      function postReview(pid, isShopView) {
        let prefix = isShopView ? "shop-rev" : "admin-rev";
        let comment = $(`#${prefix}-txt-${pid}`).val();
        let rating = $(`#${prefix}-rate-${pid}`).val();

        if (!comment || !rating) {
          alert("Please fill in comment and rating");
          return;
        }
        let data = { productId: pid, comment: comment, rating: rating };

        $.ajax({
          url: "/api/reviews",
          method: "POST",
          headers: { Authorization: "Bearer " + authToken },
          contentType: "application/json",
          data: JSON.stringify(data),
          success: () => {
            alert("Review Posted!");
            $(`#${prefix}-txt-${pid}`).val("");
            $(`#${prefix}-rate-${pid}`).val("");
            if (isShopView) loadShopReviews(pid);
            else loadAdminReviews(pid);
          },
          error: (e) =>
            alert(
              e.responseJSON ? e.responseJSON.error : "Error posting review",
            ),
        });
      }

      // --- HELPERS ---
      function fetchCategories() {
        $.get("/api/categories", function (cats) {
          categories = cats;
          let adminSelect = $("#prodCat");
          let shopSelect = $("#shopFilter");
          adminSelect.empty();
          shopSelect.html('<option value="All">All Categories</option>');
          cats.forEach((c) => {
            adminSelect.append(`<option value="${c.name}">${c.name}</option>`);
            shopSelect.append(`<option value="${c.name}">${c.name}</option>`);
          });
        });
      }
      function fetchRates() {
        $.get("/api/rates", function (rates) {
          exchangeRates = rates;
          let select = $("#currency-select");
          Object.keys(rates).forEach((c) => {
            if (c !== "SGD")
              select.append(`<option value="${c}">${c}</option>`);
          });
        });
      }
      function updateTotalCurrency() {
        let total = parseFloat($("#cart-total-sgd").text());
        let cur = $("#currency-select").val();
        let rate = exchangeRates[cur] || 1;
        $("#final-total").text((total * rate).toFixed(2));
        $("#currency-label").text(cur);
      }
      function saveProduct() {
        let id = $("#prodId").val();
        let data = {
          name: $("#prodName").val(),
          description: $("#prodDesc").val(),
          price: $("#prodPrice").val(),
          stock: $("#prodStock").val(),
          category: $("#prodCat").val(),
        };
        let method = id ? "PUT" : "POST";
        let url = id ? `/api/products/${id}` : "/api/products";
        $.ajax({
          url: url,
          method: method,
          headers: { Authorization: "Bearer " + authToken },
          data: data,
          success: function () {
            $("#product-form").slideUp();
            loadAdminProducts();
          },
          error: function (e) {
            alert("Error saving product");
          },
        });
      }
      function editProduct(id) {
        $.get(`/api/products/${id}`, function (p) {
          $("#prodId").val(p._id);
          $("#prodName").val(p.name);
          $("#prodDesc").val(p.description);
          $("#prodPrice").val(p.price);
          $("#prodStock").val(p.stock);
          $("#prodCat").val(p.category);
          $("#product-form").slideDown();
        });
      }
      function deleteProduct(id) {
        if (confirm("Delete?"))
          $.ajax({
            url: `/api/products/${id}`,
            method: "DELETE",
            headers: { Authorization: "Bearer " + authToken },
            success: loadAdminProducts,
          });
      }
      function login() {
        let email = $("#loginEmail").val();
        let password = $("#loginPass").val();
        $.ajax({
          url: "/api/login",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ email, password }),
          success: function (res) {
            authToken = res.token;
            currentUser = res.user.username;
            localStorage.setItem("token", authToken);
            localStorage.setItem("username", currentUser);
            initApp();
          },
          error: function (e) {
            alert("Login failed");
          },
        });
      }
      function register() {
        let data = {
          username: $("#regUser").val(),
          email: $("#regEmail").val(),
          password: $("#regPass").val(),
          postalCode: $("#regPostal").val(),
        };
        $.ajax({
          url: "/api/register",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (res) {
            alert("Registered!");
            $("#reg-box").hide();
            $("#login-box").show();
          },
        });
      }
      function logout() {
        localStorage.clear();
        location.reload();
      }
    </script>
  </body>
</html>
